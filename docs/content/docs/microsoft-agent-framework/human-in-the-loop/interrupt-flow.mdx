---
title: Interrupt Based
icon: "lucide/CirclePause"
description: Learn how to implement Human-in-the-Loop (HITL) using Microsoft Agent Framework's approval pattern.
---
import InstallSDKSnippet from "@/snippets/install-sdk.mdx"
import { IframeSwitcher } from "@/components/content"

{/* TODO: Swap these links for Microsoft Agent Framework links once Microsoft Agent Framework is officially added to the feature viewer */}
<IframeSwitcher
  id="human-in-the-loop-example"
  exampleUrl="https://feature-viewer.copilotkit.ai/langgraph/feature/human_in_the_loop?sidebar=false&chatDefaultOpen=false"
  codeUrl="https://feature-viewer.copilotkit.ai/langgraph/feature/human_in_the_loop?view=code&sidebar=false&codeLayout=tabs"
  exampleLabel="Demo"
  codeLabel="Code"
  height="700px"
/>

<Callout type="info">
  This example demonstrates approval-based human-in-the-loop (HITL) in the [CopilotKit Feature Viewer](https://feature-viewer.copilotkit.ai/microsoft-agent-framework/feature/human_in_the_loop).
</Callout>

## What is this?

Microsoft Agent Framework provides [approval-required function tools](https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/function-tools-approvals) for implementing Human-in-the-loop workflows.

This guide shows you how to use `ApprovalRequiredAIFunction` to require user approval before executing sensitive operations, and how to integrate it with CopilotKit's frontend.

## When should I use this?

Human-in-the-loop is essential for production-ready workflows where:
- Operations require user approval (deletions, purchases, external API calls)
- You need to ensure the agent makes correct decisions
- Users need visibility and control over agent actions

<Callout type="info">
  **For web applications with CopilotKit**, we recommend using [frontend tools](/microsoft-agent-framework/human-in-the-loop/frontend-tool-based) which provide a more seamless web-native experience. Use `ApprovalRequiredAIFunction` when you need server-side approval workflows.
</Callout>

## Implementation

<Steps>
<Step>
### Define a function that requires approval

Create a function that requires user approval before execution. Wrap it with `ApprovalRequiredAIFunction` to signal that it needs human approval.

```csharp title="Program.cs"
using System.ComponentModel;
using Azure.AI.OpenAI;
using Azure.Identity;
using Microsoft.Agents.AI;
using Microsoft.Agents.AI.Hosting.AGUI.AspNetCore;

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddAGUI();
var app = builder.Build();

string endpoint = builder.Configuration["AZURE_OPENAI_ENDPOINT"]!;
string deployment = builder.Configuration["AZURE_OPENAI_DEPLOYMENT_NAME"]!;

// [!code highlight:4]
// Define a sensitive operation that requires approval
[Description("Delete a file from the system.")]
static string DeleteFile([Description("The file path to delete")] string filePath)
    => $"File {filePath} has been deleted.";

// [!code highlight:10]
// Wrap the function in ApprovalRequiredAIFunction to require user approval
var deleteFileFunction = AIFunctionFactory.Create(DeleteFile);
var approvalRequiredFunction = new ApprovalRequiredAIFunction(deleteFileFunction);

// Create the agent with approval-required tools
var agent = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential())
    .GetChatClient(deployment)
    .CreateAIAgent(
        name: "FileManager",
        instructions: "You are a helpful file management assistant.",
        tools: [approvalRequiredFunction]);

// Map the AG-UI endpoint
app.MapAGUI("/", agent);
await app.RunAsync();
```

<Callout type="info">
  When an agent attempts to call an approval-required function, it returns a `FunctionApprovalRequestContent` instead of executing immediately.
</Callout>
</Step>
<Step>
### Handle approval requests in CopilotKit

When using `ApprovalRequiredAIFunction` with AG-UI and CopilotKit, approval requests are automatically handled by CopilotKit's frontend. You can customize the approval UI using `useCopilotAction` with a render function:

```tsx title="app/page.tsx"
import { useCopilotAction } from "@copilotkit/react-core";

function YourMainContent() {
  useCopilotAction({
    name: "DeleteFile",
    description: "Delete a file from the system",
    parameters: [
      {
        name: "filePath",
        type: "string",
        description: "The file path to delete",
        required: true,
      },
    ],
    render: ({ args, status, respond }) => {
      if (!respond || status !== "executing") return null;
      
      return (
        <div className="p-4 border rounded-lg">
          <h3 className="font-semibold">Approval Required</h3>
          <p>The agent wants to delete: <code>{args.filePath}</code></p>
          <div className="flex gap-2 mt-4">
            <button 
              onClick={() => respond({ approved: false, reason: "User rejected" })}
              className="px-4 py-2 border rounded"
            >
              Reject
            </button>
            <button 
              onClick={() => respond({ approved: true })}
              className="px-4 py-2 bg-blue-500 text-white rounded"
            >
              Approve
            </button>
          </div>
        </div>
      );
    },
  });
  
  return <div>{/* Your app content */}</div>;
}
```

<Callout type="info">
  The `respond` function in the render callback handles both approval and rejection, seamlessly integrating with MAF's approval mechanism through CopilotKit.
</Callout>
</Step>
<Step>
### Give it a try!

Try asking your agent to perform the sensitive operation. CopilotKit will automatically render your approval UI when the agent attempts to call the approval-required function.

```
Can you delete the file /tmp/test.txt?
```

The agent will request the function call, and your custom approval UI will appear, allowing the user to approve or reject the operation.
</Step>
</Steps>

## Advanced: Multiple Approval-Required Functions

You can define multiple functions that require approval, each with its own approval UI:

```csharp title="Program.cs"
// Define multiple sensitive operations
[Description("Send an email to a recipient.")]
static string SendEmail([Description("Email address")] string to, [Description("Email content")] string content)
    => $"Email sent to {to}";

[Description("Make a purchase.")]
static string MakePurchase([Description("Item name")] string item, [Description("Price")] decimal amount)
    => $"Purchased {item} for ${amount}";

// Create agent with multiple approval-required functions
var agent = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential())
    .GetChatClient(deployment)
    .CreateAIAgent(
        name: "Assistant",
        tools: [
            new ApprovalRequiredAIFunction(AIFunctionFactory.Create(SendEmail)),
            new ApprovalRequiredAIFunction(AIFunctionFactory.Create(MakePurchase))
        ]);

app.MapAGUI("/", agent);
```

On the frontend, create separate `useCopilotAction` hooks for each tool with custom approval UIs.

## Alternative: Frontend Tool-Based HITL

For more flexible, web-native human-in-the-loop patterns, consider using [frontend tools](/microsoft-agent-framework/human-in-the-loop/frontend-tool-based) with `useHumanInTheLoop`. This approach provides finer control over the approval UI and user experience.

## Give it a try!

<video src="https://cdn.copilotkit.ai/docs/copilotkit/images/coagents/interrupt-flow.mp4" className="rounded-lg shadow-xl" loop playsInline controls autoPlay muted />
