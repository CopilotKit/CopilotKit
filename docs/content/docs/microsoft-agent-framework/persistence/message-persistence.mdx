---
title: "Message Persistence"
icon: "lucide/Database"
---

<Callout>
  To learn about how to load previous messages and agent states, check out the [Loading Message History](/microsoft-agent-framework/persistence/loading-message-history) and [Loading Agent State](/microsoft-agent-framework/persistence/loading-agent-state) pages.
</Callout>

## Overview

Microsoft Agent Framework provides flexible message persistence through the `AgentThread` abstraction and custom `ChatMessageStore` implementations. Message persistence varies by the underlying service:

- **Service-managed**: Foundry Agents, OpenAI Assistants - messages stored by the service
- **In-memory**: Chat Completion models - messages managed by the agent
- **Custom storage**: Implement `ChatMessageStore` for your own database

## Using Custom Message Storage

To persist messages to your own database (PostgreSQL, MongoDB, etc.), implement a custom `ChatMessageStore`:

```csharp
using System.Text.Json;
using AGUI;
using Microsoft.Agents.AI;
using Microsoft.Agents.AI.AGUI;
using Microsoft.Extensions.AI;

public class DatabaseChatMessageStore : ChatMessageStore
{
    private readonly string _connectionString;
    private string? _threadKey;

    public DatabaseChatMessageStore(string connectionString)
    {
        _connectionString = connectionString;
        _threadKey = Guid.NewGuid().ToString(); // Generate unique key for this thread
    }

    // Deserialize from saved state
    public DatabaseChatMessageStore(JsonElement serializedState, JsonSerializerOptions? options = null)
    {
        _connectionString = serializedState.GetProperty("connectionString").GetString()!;
        _threadKey = serializedState.GetProperty("threadKey").GetString();
    }

    // Save messages to your database
    protected override async Task AddMessagesAsync(IEnumerable<ChatMessage> messages, CancellationToken cancellationToken = default)
    {
        // Store messages in your database using _threadKey and _connectionString
        // Example: await _database.InsertMessagesAsync(_threadKey, messages);
    }

    // Retrieve messages from your database
    protected override async Task<IList<ChatMessage>> GetMessagesAsync(CancellationToken cancellationToken = default)
    {
        // Retrieve messages from your database
        // Example: return await _database.GetMessagesAsync(_threadKey);
        return new List<ChatMessage>();
    }

    // Serialize state for thread persistence
    protected override Task<JsonElement> SerializeStateAsync(JsonSerializerOptions? jsonSerializerOptions = null, CancellationToken cancellationToken = default)
    {
        var state = new
        {
            connectionString = _connectionString,
            threadKey = _threadKey
        };
        return Task.FromResult(JsonSerializer.SerializeToElement(state, jsonSerializerOptions));
    }
}
```

## Using the Custom Store with AG-UI

Attach the custom message store to your agent via a factory:

```csharp
using AGUI;
using Azure.AI.OpenAI;
using Azure.Identity;
using Microsoft.Agents.AI;
using Microsoft.Agents.AI.AGUI;
using Microsoft.Agents.AI.Hosting.AGUI.AspNetCore;

var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

string endpoint = builder.Configuration["AZURE_OPENAI_ENDPOINT"]!;
string deployment = builder.Configuration["AZURE_OPENAI_DEPLOYMENT_NAME"]!;
string dbConnectionString = builder.Configuration["DatabaseConnectionString"]!;

app.MapAGUIAgent("/", (RunAgentInput agentInput, HttpContext httpContext) =>
{
    var client = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential());
    
    // Create agent with custom message store factory
    var chatClient = client.GetChatClient(deployment).AsIChatClient();
    var agent = new ChatClientAgent(
        chatClient,
        new ChatClientAgentOptions
        {
            Name = "PersistentAgent",
            Instructions = "You are a helpful assistant.",
            ChatMessageStoreFactory = ctx => new DatabaseChatMessageStore(dbConnectionString)
        });
    
    return new ChatClientAGUIAgent(agent);
});

await app.RunAsync();
```

<Callout type="info">
  The `ChatMessageStoreFactory` is called when creating each thread, allowing you to inject custom persistence logic. The `ctx` parameter provides serialized state and JSON options for deserialization.
</Callout>

## Learn More

For detailed information about message persistence in Microsoft Agent Framework:
- [Storing Chat History in 3rd Party Storage](https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/third-party-chat-history-storage)
- [Persisting and Resuming Agent Conversations](https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/persisted-conversation)
- [Multi-Turn Conversations and Threading](https://learn.microsoft.com/en-us/agent-framework/user-guide/agents/multi-turn-conversation)