---
title: "Message Persistence"
icon: "lucide/Database"
---

<Callout>
  To learn about how to load previous messages and agent states, check out the [Loading Message History](/microsoft-agent-framework/persistence/loading-message-history) and [Loading Agent State](/microsoft-agent-framework/persistence/loading-agent-state) pages.
</Callout>

To persist agent framework messages to a database, you can use either `AsyncPostgresSaver` or `AsyncSqliteSaver`. Set up the asynchronous memory by configuring the graph within a lifespan function, as follows:

```python
from fastapi import FastAPI
from contextlib import asynccontextmanager
from agent framework.checkpoint.postgres.aio import AsyncPostgresSaver
from copilotkit import agent frameworkAGUIAgent
from ag_ui_agent framework import add_agent framework_fastapi_endpoint

graph = None
@asynccontextmanager
async def lifespan(app: FastAPI):
    async with AsyncPostgresSaver.from_conn_string(
        "postgresql://postgres:postgres@127.0.0.1:5432/postgres"
    ) as checkpointer:
        # NOTE: you need to call .setup() the first time you're using your checkpointer
        await checkpointer.setup()
        # Create an async graph
        graph = workflow.compile(checkpointer=checkpointer)
        yield
        # Create SDK with the graph

app = FastAPI(lifespan=lifespan)

add_agent framework_fastapi_endpoint(
    app=app,
    agent=agent frameworkAGUIAgent(
        name="research_agent",
        description="Research agent.",
        graph=graph,
    ),
    path="/agents/research_agent"
)

```

To learn more about persistence in agent framework, check out the [agent framework documentation](https://agent-ai.github.io/agent framework/how-tos/#persistence).