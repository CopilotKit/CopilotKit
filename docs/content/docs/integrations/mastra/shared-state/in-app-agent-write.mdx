---
title: Writing agent state
icon: "lucide/ArrowRight"
description: Write to agent's state from your application.
---
import { ImageZoom } from 'fumadocs-ui/components/image-zoom';
import RunAndConnect from "@/snippets/integrations/mastra/run-and-connect.mdx"
import { IframeSwitcher } from "@/components/content"

<IframeSwitcher
  id="shared-state-write-example"
  exampleUrl="https://feature-viewer.copilotkit.ai/mastra/feature/shared_state?sidebar=false&chatDefaultOpen=false"
  codeUrl="https://feature-viewer.copilotkit.ai/mastra/feature/shared_state?view=code&sidebar=false&codeLayout=tabs"
  exampleLabel="Demo"
  codeLabel="Code"
  height="700px"
/>

<Callout type="info">
  This example demonstrates writing to shared state in the [CopilotKit Feature Viewer](https://feature-viewer.copilotkit.ai/mastra/feature/shared_state).
</Callout>

## What is this?

You can easily write to your agent's state from your native application, allowing you to update the agent's working memory from your UI.

<Callout type="info" title="Important">
  This guide assumes you are embedding your Mastra agent inside of Copilot Runtime, like so.

  ```ts
  const runtime = new CopilotRuntime({
    agents: MastraAgent.getLocalAgents({ mastra }),
  });
  ```

  This feature will **not work** if you are using a **remote Mastra agent**.
</Callout>

## When should I use this?

You can use this when you want to provide user input or control to your agent's working memory. As your application state changes, you can update the agent state to reflect these changes.

## Implementation

<Steps>
  <Step>
    ### Run and connect your agent
    <RunAndConnect components={props.components} />
  </Step>
  <Step>
    ### Define the Agent State
    Mastra has advanced [working memory concepts](https://mastra.ai/en/docs/memory/working-memory) to provide statefulness to your agents. CopilotKit leverages Mastra's working memory concept to allow you to
    implement shared state between your agent and your application.

    Providing working memory to your agent is as simple as providing a Zod schema to your agent.

    ```ts title="mastra/agents/language-agent.ts"
    import { openai } from "@ai-sdk/openai";
    import { Agent } from "@mastra/core/agent";
    import { LibSQLStore } from "@mastra/libsql";
    import { z } from "zod";
    import { Memory } from "@mastra/memory";

    // [!code highlight:4]
    // 1. Define the agent state schema
    export const AgentStateSchema = z.object({
      language: z.enum(["english", "spanish"]),
    });

    // 2. Infer the agent state type from the schema
    export const AgentState = z.infer<typeof AgentStateSchema>;

    // 3. Create the agent
    export const languageAgent = new Agent({
      name: "Language Agent",
      model: openai("gpt-4o"),
      instructions: "Always communicate in the preferred language of the user as defined in your working memory. Do not communicate in any other language.",
      memory: new Memory({
        storage: new LibSQLStore({ url: "file::memory:" }),
        options: {
          // [!code highlight:4]
          workingMemory: {
            enabled: true,
            schema: AgentStateSchema,
          },
        },
      }),
    });
    ```    
  </Step>
  <Step>
    ### Use the `useCoAgent` Hook
    With your agent connected and running all that is left is to call the [useCoAgent](/reference/hooks/useCoAgent) hook, pass the agent's name, and
    use the `setState` function to update the agent state.

    ```tsx title="ui/app/page.tsx"
    import { useCoAgent } from "@copilotkit/react-core"; // [!code highlight]
    import { AgentState } from "@/mastra/agents/language-agent";

    function YourMainContent() {
      // [!code highlight:5]
      const { state, setState } = useCoAgent<AgentState>({
        name: "your-mastra-agent-name",
        // optionally provide a type-safe initial state
        initialState: { language: "english" }  
      });

      const toggleLanguage = () => {
        setState({ language: state.language === "english" ? "spanish" : "english" }); // [!code highlight]
      };

      return (
        // style excluded for brevity
        <div>
          <h1>Your main content</h1>
          {/* [!code highlight:2] */}
          <p>Language: {state.language}</p> 
          <button onClick={toggleLanguage}>Toggle Language</button>
        </div>
      );
    }
    ```
    <Callout type="info">
      The `setState` function in `useCoAgent` will update the working memory and trigger a rerender when the state changes.
    </Callout>
  </Step>
  <Step>
    ### Give it a try!
    You can now use the `setState` function to update the agent state and `state` to read it. Try toggling the language button
    and talking to your agent. You'll see the language change to match the agent's state.

    <Callout type="info" title="Important">
      Shared-state in Mastra is prompt-driven. This means that your Agent's awareness of the shared state will be augmented
      by the instructions you provide to your agent.
    </Callout>
  </Step>
</Steps>
