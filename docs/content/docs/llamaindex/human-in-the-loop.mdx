---
title: Human-in-the-Loop (HITL)
description: Learn how to implement Human-in-the-Loop (HITL) using LlamaIndex Agents.
icon: lucide/Share2
---
import { IframeSwitcher } from "@/components/content"
import RunAndConnect from "@/snippets/integrations/llamaindex/run-and-connect.mdx"

<IframeSwitcher
  id="human-in-the-loop-example"
  exampleUrl="https://feature-viewer.copilotkit.ai/langgraph/feature/human_in_the_loop?sidebar=false&chatDefaultOpen=false"
  codeUrl="https://feature-viewer.copilotkit.ai/langgraph/feature/human_in_the_loop?view=code&sidebar=false&codeLayout=tabs"
  exampleLabel="Demo"
  codeLabel="Code"
  height="700px"
/>

<Callout type="info">
  This example demonstrates interrupt-based human-in-the-loop (HITL) in the [CopilotKit Feature Viewer](https://feature-viewer.copilotkit.ai/langgraph/feature/human_in_the_loop).
</Callout>

## What is this?


CopilotKit lets you to add custom UI to take user input and then pass it back to the agent upon completion.

## Why should I use this?

Human-in-the-loop is a powerful way to implement complex workflows that are production ready. By having a human in the loop,
you can ensure that the agent is always making the right decisions and ultimately is being steered in the right direction.

## Implementation

<Steps>
    <Step>
        ### Run and connect your agent
        <RunAndConnect components={props.components} />
    </Step>

    <Step>
        ### Add a tool to your agent
        Add a tool to your agent that will be used to write an essay. Since the tool will be used in the frontend,
        we'll add it to the `frontend_tools` list.

        ```python title="agent-py/agent/agent.py"
        from llama_index.protocols.ag_ui.router import get_ag_ui_workflow_router
        from llama_index.llms.openai import OpenAI

        def write_essay(draft: str) -> str:
            """Writes an essay and takes the draft as an argument."""
            return "Essay draft written!"

        agentic_chat_router = get_ag_ui_workflow_router(
            llm=OpenAI(model="gpt-4.1"),
            frontend_tools=[write_essay],
        )
        ```

        ```python title="agent-py/agent/server.py"
        from fastapi import FastAPI
        from agent.agent import agentic_chat_router

        app = FastAPI()
        app.include_router(agentic_chat_router)

        if __name__ == "__main__":
            import uvicorn
            uvicorn.run(app, host="0.0.0.0", port=8000)
        ```
    </Step>

    <Step>
        ### Add a `useCopilotAction` to your Frontend
        First, we'll create a component that renders the agent's essay draft and waits for user approval.

        ```tsx title="ui/app/page.tsx"
        import { useCopilotAction } from "@copilotkit/react-core"
        import { Markdown } from "@copilotkit/react-ui"

        function YourMainContent() {
          // ...

          useCopilotAction({
            name: "write_essay",
            available: "remote",
            description: "Writes an essay and takes the draft as an argument.",
            parameters: [
              { name: "draft", type: "string", description: "The draft of the essay", required: true },
            ],
            followUp: false,
            // [!code highlight:31]
            renderAndWaitForResponse: ({ args, respond, status }) => {
              return (
                <div>
                  <Markdown content={args.draft || 'Preparing your draft...'} />

                  <div className={`flex gap-4 pt-4 ${status !== "executing" ? "hidden" : ""}`}>
                    <button
                      onClick={() => {
                        respond?.("CANCEL");
                        alert("Draft canceled (ignored by default)");
                      }}
                      disabled={status !== "executing"}
                      className="border p-2 rounded-xl w-full"
                    >
                      Try Again
                    </button>
                    <button
                      onClick={() => {
                        respond?.("SEND");
                        alert("Draft approved\n\nNow do something with it âœ¨");
                      }}
                      disabled={status !== "executing"}
                      className="bg-blue-500 text-white p-2 rounded-xl w-full"
                    >
                      Approve Draft
                    </button>
                  </div>
                </div>
              );
            },
          });

          // ...
        }
        ```
    </Step>

    <Step>
    ### Setup the LlamaIndex Agent
    On the agent side, we are already done! LlamaIndex natively supports the AG-UI protocol and will automatically
    pass control back to the frontend when the `writeEssay` action is found in the model's response.
    </Step>

    <Step>
    ### Give it a try!
    Try asking your agent to write an essay about the benefits of AI. You'll see that it will generate an essay,
    stream the progress and eventually ask you to review it.

    <video
      src="https://cdn.copilotkit.ai/docs/copilotkit/images/coagents/node-hitl.mp4"
      className="rounded-lg shadow-xl"
      loop
      playsInline
      controls
      autoPlay
      muted
    />
    </Step>

</Steps>
